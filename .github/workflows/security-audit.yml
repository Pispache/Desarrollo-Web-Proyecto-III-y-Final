# @summary Auditor√≠as de seguridad y SBOM (A06 y A08).
# @effects Detecta vulnerabilidades conocidas y documenta la cadena de suministro.
name: Security Audit & SBOM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 3 * * 1'

jobs:
  node-audit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workdir: [
          'backend-auth-service/auth-service',
          'infra/services/pdf-renderer',
          'frontend/ui'
        ]
    defaults:
      run:
        working-directory: ${{ matrix.workdir }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci --omit=dev
      - run: npm audit --production || true

  python-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend-reports/reports
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements.txt
      - uses: pypa/gh-action-pip-audit@v1.0.8
        with:
          inputs: requirements.txt
        continue-on-error: true

  dotnet-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend-api/api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - run: dotnet restore
      - run: dotnet list package --vulnerable || true

  trivy-repo-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy in repo mode
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-repo.sarif'
          severity: 'CRITICAL,HIGH'
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-repo.sarif'

  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          artifact-name: sbom-spdx.json
      - uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx
          path: sbom-spdx.json
